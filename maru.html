<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ストレス診断（30問・7段階・10問ずつ）</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f4f5f7; --text:#111827; --muted:#6b7280; --card:#fff; --brand:#4f46e5;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:"Noto Sans JP",system-ui,-apple-system}
    .wrap{max-width:960px;margin:0 auto;padding:24px 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{font-weight:700;font-size:1.2rem;color:var(--brand)}
    .progress{flex:1;height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:var(--brand);transition:width .25s ease}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:.8rem}

    .card{background:var(--card);border-radius:16px;padding:24px;box-shadow:0 10px 25px rgba(0,0,0,.05)}

    .group-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .group-title{font-weight:700}
    .scale-legend{display:flex;gap:12px;color:var(--muted);font-size:.85rem;align-items:center}
    .legend-dot{width:10px;height:10px;border-radius:50%}

    .q-list{display:grid;grid-template-columns:1fr;gap:18px}
    .q-item{padding:14px 14px;border-radius:12px;border:1px solid #e5e7eb}
    .qtop{display:flex;justify-content:space-between;gap:10px;align-items:baseline;margin-bottom:8px}
    .qnum{color:var(--muted);font-size:.9rem}
    .qtext{font-size:1.05rem;line-height:1.6}

    /* 7段階ドット */
    .scale{display:flex;align-items:center;gap:10px;margin-top:8px}
    .scale .side{width:140px;font-size:.85rem;color:var(--muted)}
    .scale .dots{display:flex;gap:10px}
    .option{position:relative}
    input[type=radio]{position:absolute;opacity:0;pointer-events:none}
    .dot{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid #e5e7eb;cursor:pointer;user-select:none;transition:transform .08s ease}
    .dot[data-pos="1"]{border-color:#fde2e2}
    .dot[data-pos="2"]{border-color:#fbd0d0}
    .dot[data-pos="3"]{border-color:#f8b4b4}
    .dot[data-pos="4"]{border-color:#d1d5db}
    .dot[data-pos="5"]{border-color:#bbf7d0}
    .dot[data-pos="6"]{border-color:#86efac}
    .dot[data-pos="7"]{border-color:#4ade80}
    .dot:active{transform:scale(.96)}
    input:checked + .dot{background:var(--brand);border-color:var(--brand);color:#fff}

    .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:18px}
    button{padding:12px 18px;border-radius:10px;border:none;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
    button.secondary{background:#e5e7eb;color:#111827}
    button:disabled{opacity:.5;cursor:not-allowed}

    .hint{margin:8px 0 0;color:#dc2626;font-size:.9rem;display:none}
    .note{margin:0 0 8px;color:var(--muted);font-size:.95rem}

    footer{margin-top:20px;color:var(--muted);font-size:.8rem;text-align:center}

    @media (max-width:700px){
      .scale{flex-direction:column;align-items:flex-start}
      .scale .side{width:auto}
      .dot{width:34px;height:34px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">ストレス診断</div>
      <div class="progress" aria-label="進捗"><div class="bar" id="bar"></div></div>
      <div class="pill"><span id="pillIndex">1</span>-<span id="pillEnd">10</span>/<span id="pillTotal">30</span></div>
    </header>

    <main class="card" role="region" aria-live="polite">
      <div class="group-head">
        <div class="group-title" id="groupTitle">Q1〜Q10</div>
        <div class="scale-legend">
          <span class="legend-dot" style="background:#f8b4b4;border:1px solid #f8b4b4"></span>否定的
          <span class="legend-dot" style="background:#d1d5db;border:1px solid #d1d5db"></span>中立
          <span class="legend-dot" style="background:#86efac;border:1px solid #86efac"></span>肯定的
        </div>
      </div>

      <p class="note">各項目について、<strong>ストレスを感じたとき</strong>のあなたの傾向にどの程度当てはまるかを選んでください。</p>
      <p class="hint" id="hint"></p>

      <form id="form">
        <div class="q-list" id="qList"></div>
        <div class="actions">
          <button type="button" class="secondary" id="prevBtn">前の10問</button>
          <button type="button" id="nextBtn">次の10問</button>
          <button type="button" id="finishBtn">結果へ</button>
        </div>
      </form>
    </main>

    <footer>※ 回答は端末内にのみ一時保存されます（リロードで消えます）。</footer>
  </div>

  <script>
  // ===== 結果ページ =====
  const TYPE_PAGES = {
    THOUGHT: 'shikoresult.html', // 思考タイプ
    EMOTION: 'jodoresult.html',  // 情動タイプ
    ACTION:  'kodoresult.html',  // 行動タイプ
    AVOID:   'kaihiresult.html'  // 回避タイプ
  };

  // ===== 質問（30問） =====
  // 配分: 思考8（PROBLEM4 + REAPPRAISAL4）, 情動8（EMOTION4 + SUPPORT4）, 行動7（DISTRACT7）, 回避7（RELAX7）
  const QUESTIONS = [
    // PROBLEM (4)
    { t:'ストレスを感じたとき、原因を洗い出して対策リストを作る。', k:'PROBLEM' },
    { t:'ストレスを感じたとき、締め切りや優先順位を見直して計画を立て直す。', k:'PROBLEM' },
    { t:'ストレスを感じたとき、まず事実を集めて情報を整理する。', k:'PROBLEM' },
    { t:'ストレスを感じたとき、次にやるべき一手（ToDo）を書き出す。', k:'PROBLEM' },

    // REAPPRAISAL (4)
    { t:'ストレスを感じたとき、出来事の意味づけを変えて前向きに捉え直す。', k:'REAPPRAISAL' },
    { t:'ストレスを感じたとき、「最悪」ではなく「現実的な想定」を考える。', k:'REAPPRAISAL' },
    { t:'ストレスを感じたとき、自分にコントロールできる範囲を切り分ける。', k:'REAPPRAISAL' },
    { t:'ストレスを感じたとき、失敗から学べる点を探す。', k:'REAPPRAISAL' },

    // EMOTION (4)
    { t:'ストレスを感じたとき、つらさや不安を言葉にして表現する。', k:'EMOTION' },
    { t:'ストレスを感じたとき、泣く／日記を書くなどで気持ちを発散する。', k:'EMOTION' },
    { t:'ストレスを感じたとき、安心できる空間で自分の感情に向き合う。', k:'EMOTION' },
    { t:'ストレスを感じたとき、音楽やアートで気持ちの整理を助ける。', k:'EMOTION' },

    // SUPPORT (4)
    { t:'ストレスを感じたとき、信頼できる人に相談してフィードバックをもらう。', k:'SUPPORT' },
    { t:'ストレスを感じたとき、同じ経験のコミュニティや体験談を探す。', k:'SUPPORT' },
    { t:'ストレスを感じたとき、ためらわず助けを求めるメッセージを送る。', k:'SUPPORT' },
    { t:'ストレスを感じたとき、家族や友人と過ごして安心感を得る。', k:'SUPPORT' },

    // DISTRACT (7)
    { t:'ストレスを感じたとき、運動や散歩で気分転換する。', k:'DISTRACT' },
    { t:'ストレスを感じたとき、趣味やゲーム、動画で一度頭を切り替える。', k:'DISTRACT' },
    { t:'ストレスを感じたとき、短い休憩を入れて集中を戻す。', k:'DISTRACT' },
    { t:'ストレスを感じたとき、場所を変える（カフェ等）ことで気分を変える。', k:'DISTRACT' },
    { t:'ストレスを感じたとき、早歩きやストレッチでスイッチを入れ直す。', k:'DISTRACT' },
    { t:'ストレスを感じたとき、軽い片付けや家事で気を紛らわす。', k:'DISTRACT' },
    { t:'ストレスを感じたとき、笑える動画を見て緊張をほぐす。', k:'DISTRACT' },

    // RELAX (7)
    { t:'ストレスを感じたとき、深呼吸・瞑想・マインドフルネスで落ち着かせる。', k:'RELAX' },
    { t:'ストレスを感じたとき、入浴やマッサージ、アロマで緊張をゆるめる。', k:'RELAX' },
    { t:'ストレスを感じたとき、就寝前のルーティンを守り睡眠リズムを整える。', k:'RELAX' },
    { t:'ストレスを感じたとき、自然の中で静かな時間を過ごす。', k:'RELAX' },
    { t:'ストレスを感じたとき、腹式呼吸やストレッチで自律神経を整える。', k:'RELAX' },
    { t:'ストレスを感じたとき、ゆっくり過ごす時間を意識的につくる。', k:'RELAX' },
    { t:'ストレスを感じたとき、スマホから離れてデジタルデトックスする。', k:'RELAX' },
  ];

  // --- シャッフル（全体） ---
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const r=Math.floor(Math.random()*(i+1));
      [arr[i],arr[r]]=[arr[r],arr[i]];
    }
    return arr;
  }
  const qs = shuffle([...QUESTIONS]); // 全30問

  // --- 状態 ---
  const state = { page:0, answers:Array(qs.length).fill(null) };

  // --- DOM ---
  const qList = document.getElementById('qList');
  const bar = document.getElementById('bar');
  const groupTitle = document.getElementById('groupTitle');
  const pillIndex = document.getElementById('pillIndex');
  const pillEnd = document.getElementById('pillEnd');
  const pillTotal = document.getElementById('pillTotal');
  const hint = document.getElementById('hint');
  pillTotal.textContent = qs.length;

  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const finishBtn = document.getElementById('finishBtn');

  prevBtn.addEventListener('click', () => { if(state.page>0){ state.page--; renderPage(); } });
  nextBtn.addEventListener('click', () => {
    const totalPages = Math.ceil(qs.length/10);
    if(!pageFullyAnswered()){
      showUnansweredHint();
      return;
    }
    if(state.page<totalPages-1){ state.page++; renderPage(); }
  });
  finishBtn.addEventListener('click', () => finish());

  function pageFullyAnswered(){
    const start = state.page*10;
    const end = Math.min(start+10, qs.length);
    for(let i=start;i<end;i++){ if(state.answers[i]==null) return false; }
    return true;
  }
  function showUnansweredHint(){
    const start = state.page*10;
    const end = Math.min(start+10, qs.length);
    let left = 0;
    for(let i=start;i<end;i++){ if(state.answers[i]==null) left++; }
    hint.textContent = `このページに未回答が ${left} 問あります。すべて回答してください。`;
    hint.style.display = 'block';
    setTimeout(()=>{ hint.style.display='none'; }, 3000);
  }

  function renderPage(){
    const totalPages = Math.ceil(qs.length/10);
    const start = state.page*10;
    const end = Math.min(start+10, qs.length);
    groupTitle.textContent = `Q${start+1}〜Q${end}`;
    pillIndex.textContent = start+1;
    pillEnd.textContent = end;
    bar.style.width = `${(end/qs.length)*100}%`;

    qList.innerHTML = '';
    for(let i=start;i<end;i++){
      const q = qs[i];
      const item = document.createElement('div');
      item.className = 'q-item';

      const top = document.createElement('div');
      top.className = 'qtop';
      const num = document.createElement('div');
      num.className = 'qnum';
      num.textContent = `Q${i+1}`;
      const text = document.createElement('div');
      text.className = 'qtext';
      text.textContent = q.t;
      top.appendChild(num); top.appendChild(text);

      const scale = document.createElement('div');
      scale.className = 'scale';
      const left = document.createElement('div'); left.className='side'; left.textContent = '全く当てはまらない';
      const right = document.createElement('div'); right.className='side'; right.textContent = 'とても当てはまる';
      const dots = document.createElement('div'); dots.className='dots';

      for(let v=1; v<=7; v++){
        const wrap = document.createElement('label');
        wrap.className='option';
        const input = document.createElement('input');
        input.type='radio'; input.name=`q${i}`; input.value=v; input.checked = state.answers[i]===v;
        input.addEventListener('change', ()=>{ state.answers[i]=v; });
        const dot = document.createElement('span'); dot.className='dot'; dot.dataset.pos=String(v); dot.textContent='';
        wrap.appendChild(input); wrap.appendChild(dot); dots.appendChild(wrap);
      }

      scale.appendChild(left); scale.appendChild(dots); scale.appendChild(right);
      item.appendChild(top); item.appendChild(scale);
      qList.appendChild(item);
    }

    prevBtn.disabled = state.page===0;
    nextBtn.style.display = state.page<totalPages-1 ? 'inline-block' : 'none';
    finishBtn.style.display = state.page===totalPages-1 ? 'inline-block' : 'none';
  }

  function requireAllAnswered(){
    return state.answers.every(v => v !== null);
  }

  // タイブレーク：7の個数→6の個数→5の個数→合計
  function buildTypeVectors(filled, idxByType){
    const vec = {};
    for(const key of Object.keys(idxByType)){
      const arr = idxByType[key].map(i => filled[i]);
      const counts = {7:0,6:0,5:0};
      for(const v of arr){
        if(v===7) counts[7]++; else if(v===6) counts[6]++; else if(v===5) counts[5]++;
      }
      const sum = arr.reduce((a,b)=>a+b,0);
      vec[key] = {counts, sum, arr};
    }
    return vec;
  }

  function finish(){
    const totalPages = Math.ceil(qs.length/10);
    if(state.page<totalPages-1 || !pageFullyAnswered()){
      showUnansweredHint();
      return;
    }
    if(!requireAllAnswered()){
      hint.textContent = '未回答の設問があります。すべて回答してください。';
      hint.style.display = 'block';
      setTimeout(()=>{ hint.style.display='none'; }, 3000);
      return;
    }

    const filled = state.answers.slice(); // 全て回答済み
    // インデックスをタイプ別に収集
    const idxByKey = { PROBLEM:[], REAPPRAISAL:[], EMOTION:[], SUPPORT:[], DISTRACT:[], RELAX:[] };
    qs.forEach((q, i)=> idxByKey[q.k]?.push(i));

    // キー別合計
    const copingScores = {};
    for(const k of Object.keys(idxByKey)){
      copingScores[k] = idxByKey[k].reduce((acc,i)=> acc + filled[i], 0);
    }

    const typeScores = {
      THOUGHT: (copingScores.PROBLEM||0) + (copingScores.REAPPRAISAL||0), // 8問
      EMOTION: (copingScores.EMOTION||0) + (copingScores.SUPPORT||0),     // 8問
      ACTION:  (copingScores.DISTRACT||0),                                // 7問
      AVOID:   (copingScores.RELAX||0)                                     // 7問
    };

    // タイブレーク用ベクトル
    const idxByType = {
      THOUGHT: [...(idxByKey.PROBLEM||[]), ...(idxByKey.REAPPRAISAL||[])],
      EMOTION: [...(idxByKey.EMOTION||[]), ...(idxByKey.SUPPORT||[])],
      ACTION:  [...(idxByKey.DISTRACT||[])],
      AVOID:   [...(idxByKey.RELAX||[])]
    };
    const vec = buildTypeVectors(filled, idxByType);

    // 最高スコアを抽出
    const order = ['THOUGHT','EMOTION','ACTION','AVOID'];
    let best = order[0];
    for(const k of order){
      if(typeScores[k] > typeScores[best]) best = k;
    }
    // 同点の場合の厳密比較
    const maxScore = typeScores[best];
    const candidates = order.filter(k => typeScores[k] === maxScore);
    let bestType = candidates[0];
    if(candidates.length > 1){
      candidates.sort((a,b)=>{
        // 7の数
        if(vec[b].counts[7] !== vec[a].counts[7]) return vec[b].counts[7]-vec[a].counts[7];
        // 6の数
        if(vec[b].counts[6] !== vec[a].counts[6]) return vec[b].counts[6]-vec[a].counts[6];
        // 5の数
        if(vec[b].counts[5] !== vec[a].counts[5]) return vec[b].counts[5]-vec[a].counts[5];
        // 合計（理論上同点だが一応）
        if(vec[b].sum !== vec[a].sum) return vec[b].sum-vec[a].sum;
        // ここまで同じなら定義順
        return order.indexOf(a)-order.indexOf(b);
      });
      bestType = candidates[0];
    }

    const url = TYPE_PAGES[bestType] || 'shikoresult.html';
    window.location.href = url;
  }

  // 初期描画
  renderPage();
  </script>
</body>
</html>
